<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: SmsPolicyCheckerService
  
    &mdash; SMS Policy Checker Service Documentation
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "SmsPolicyCheckerService";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index (S)</a> &raquo;
    
    
    <span class="title">SmsPolicyCheckerService</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: SmsPolicyCheckerService
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">SmsPolicyCheckerService</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>app/services/sms_policy_checker_service.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<h2 id="label-SmsPolicyCheckerService">SmsPolicyCheckerService</h2>

<p>Service class responsible for analyzing SMS message content against a set of predefined policies and generating a compliance report. It operates in two main layers:</p>

<p>Layer 1: Performs checks based on compiled regular expression rules. This layer</p>

<pre class="code ruby"><code class="ruby">can trigger an &quot;early exit&quot; if a high-confidence violation is found.
</code></pre>

<p>Layer 2: Utilizes Google’s Generative AI (Gemini), Natural Language API, and</p>

<pre class="code ruby"><code class="ruby">Safe Browse API to perform more nuanced analysis of the message against
various policy characteristics. This layer is only processed if Layer 1
does not trigger an early exit and if no critical API errors occur.
</code></pre>

<p>The service can operate in a ‘:fallback_layer1_only` mode if critical errors occur during Layer 2 API interactions, ensuring that a result (based solely on Layer 1) is still provided.</p>

<p>The final report includes a pass/fail result, a reason, a confidence score, details of any violations found, policy category scores, and potentially a rewrite suggestion if the message fails in full analysis mode.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
      <pre class="example code"><code><span class='id identifier rubyid_report'>report</span> <span class='op'>=</span> <span class='const'>SmsPolicyCheckerService</span><span class='period'>.</span><span class='id identifier rubyid_call'><span class='object_link'><a href="#call-class_method" title="SmsPolicyCheckerService.call (method)">call</a></span></span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Check out this amazing offer: http://example.com/promo</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_report'>report</span><span class='lbracket'>[</span><span class='symbol'>:result</span><span class='rbracket'>]</span> <span class='comment'># =&gt; :pass or :fail
</span><span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_report'>report</span><span class='lbracket'>[</span><span class='symbol'>:reason</span><span class='rbracket'>]</span>
<span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_report'>report</span><span class='lbracket'>[</span><span class='symbol'>:violation_details</span><span class='rbracket'>]</span></code></pre>
    
  </div>


</div>



  <h2>Instance Attribute Summary <small><a href="#" class="summary_toggle">collapse</a></small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#message_analysis_report-instance_method" title="#message_analysis_report (instance method)">#<strong>message_analysis_report</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the value of attribute message_analysis_report.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#message_body-instance_method" title="#message_body (instance method)">#<strong>message_body</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the value of attribute message_body.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#pre_fetched_api_signals-instance_method" title="#pre_fetched_api_signals (instance method)">#<strong>pre_fetched_api_signals</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the value of attribute pre_fetched_api_signals.</p>
</div></span>
  
</li>

    
  </ul>




  
    <h2>
      Class Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#call-class_method" title="call (class method)">.<strong>call</strong>(message_body)  &#x21d2; Hash </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Class-level convenience method to instantiate and call the service.</p>
</div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#add_l1_violation_detail-instance_method" title="#add_l1_violation_detail (instance method)">#<strong>add_l1_violation_detail</strong>(rule, matched_value)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Adds a violation detail entry to the report for a Layer 1 rule match.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#add_l2_violation_detail-instance_method" title="#add_l2_violation_detail (instance method)">#<strong>add_l2_violation_detail</strong>(characteristic_name, rationale, confidence)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Adds a detail entry to the report for a Layer 2 LLM characteristic evaluation.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#add_rewrite_suggestion_if_applicable-instance_method" title="#add_rewrite_suggestion_if_applicable (instance method)">#<strong>add_rewrite_suggestion_if_applicable</strong>  &#x21d2; void </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Adds a rewrite suggestion to the report if the message failed in full analysis mode.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#build_gemini_prompt-instance_method" title="#build_gemini_prompt (instance method)">#<strong>build_gemini_prompt</strong>(characteristic_config, pre_fetched_signals)  &#x21d2; String </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Constructs the prompt to be sent to the Gemini LLM for a specific policy characteristic.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#call-instance_method" title="#call (instance method)">#<strong>call</strong>  &#x21d2; Hash </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Executes the full SMS policy checking process.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#determine_characteristic_relevancy-instance_method" title="#determine_characteristic_relevancy (instance method)">#<strong>determine_characteristic_relevancy</strong>(char_config)  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Determines if a given LLM characteristic is relevant for the current message based on “relevancy_skip_conditions” in its configuration.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#determine_final_result_and_reason-instance_method" title="#determine_final_result_and_reason (instance method)">#<strong>determine_final_result_and_reason</strong>  &#x21d2; void </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Calculates the final ‘:result` (:pass or :fail), `:reason`, and `:confidence` for the overall analysis report based on aggregated scores.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#determine_final_result_if_not_concluded-instance_method" title="#determine_final_result_if_not_concluded (instance method)">#<strong>determine_final_result_if_not_concluded</strong>(layer1_halted, critical_l2_failure_occurred)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Determines the final result and reason if not already concluded by L1 early exit or L2 critical failure.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#extract_urls_from_message_body-instance_method" title="#extract_urls_from_message_body (instance method)">#<strong>extract_urls_from_message_body</strong>  &#x21d2; Array&lt;String&gt; </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Extracts all HTTP and HTTPS URLs from the message body.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#fetch_nl_entities_signals-instance_method" title="#fetch_nl_entities_signals (instance method)">#<strong>fetch_nl_entities_signals</strong>  &#x21d2; void </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Fetches entity analysis signals from Google Natural Language API.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#fetch_nl_moderation_signals-instance_method" title="#fetch_nl_moderation_signals (instance method)">#<strong>fetch_nl_moderation_signals</strong>  &#x21d2; void </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Fetches text moderation signals from Google Natural Language API.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#fetch_safebrowse_signals-instance_method" title="#fetch_safebrowse_signals (instance method)">#<strong>fetch_safebrowse_signals</strong>  &#x21d2; void </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Fetches signals from Google Safe Browse API.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#gather_auxiliary_api_signals-instance_method" title="#gather_auxiliary_api_signals (instance method)">#<strong>gather_auxiliary_api_signals</strong>  &#x21d2; void </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Collects signals from auxiliary APIs (Safe Browse, Natural Language API for entities and moderation).</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#generate_rewrite_suggestion-instance_method" title="#generate_rewrite_suggestion (instance method)">#<strong>generate_rewrite_suggestion</strong>  &#x21d2; String, ... </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Attempts to generate a rewrite suggestion for a failing message using the Gemini LLM.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#handle_api_errors_and_fallback-instance_method" title="#handle_api_errors_and_fallback (instance method)">#<strong>handle_api_errors_and_fallback</strong>(error_type, options = {})  &#x21d2; void </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Manages the transition to ‘:fallback_layer1_only` processing mode when a significant API error occurs during Layer 2.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">#<strong>initialize</strong>(message_body)  &#x21d2; SmsPolicyCheckerService </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Initializes a new instance of the SmsPolicyCheckerService.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#initialize_report-instance_method" title="#initialize_report (instance method)">#<strong>initialize_report</strong>  &#x21d2; Hash </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Initializes the structure for the analysis report.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#process_layer1_rules-instance_method" title="#process_layer1_rules (instance method)">#<strong>process_layer1_rules</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Processes the message against Layer 1 rules (typically regex-based).</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#process_layer2_llm_analysis-instance_method" title="#process_layer2_llm_analysis (instance method)">#<strong>process_layer2_llm_analysis</strong>  &#x21d2; Symbol </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Manages the Layer 2 analysis using the Gemini LLM for various policy characteristics.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#process_single_characteristic-instance_method" title="#process_single_characteristic (instance method)">#<strong>process_single_characteristic</strong>(char_config, gemini_client)  &#x21d2; Symbol </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Processes a single LLM characteristic: determines relevancy, calls Gemini, and handles response.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#set_critical_l2_failure-instance_method" title="#set_critical_l2_failure (instance method)">#<strong>set_critical_l2_failure</strong>(characteristic_name, confidence)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Updates the analysis report to reflect a critical failure based on a Layer 2 LLM characteristic evaluation that met or exceeded its critical threshold.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#set_early_exit_failure-instance_method" title="#set_early_exit_failure (instance method)">#<strong>set_early_exit_failure</strong>(rule)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Updates the analysis report to reflect an early exit failure based on a Layer 1 rule.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#summarize_nl_entities_for_prompt-instance_method" title="#summarize_nl_entities_for_prompt (instance method)">#<strong>summarize_nl_entities_for_prompt</strong>(signals)  &#x21d2; String </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Generates a summary string for Natural Language Entities results to be used in prompts.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#summarize_nl_moderation_for_prompt-instance_method" title="#summarize_nl_moderation_for_prompt (instance method)">#<strong>summarize_nl_moderation_for_prompt</strong>(signals)  &#x21d2; String </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Generates a summary string for Text Moderation results to be used in prompts.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#summarize_safe_browse_for_prompt-instance_method" title="#summarize_safe_browse_for_prompt (instance method)">#<strong>summarize_safe_browse_for_prompt</strong>(signals)  &#x21d2; String </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Generates a summary string for Safe Browse results to be used in prompts.</p>
</div></span>
  
</li>

      
    </ul>
  

<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    #<strong>initialize</strong>(message_body)  &#x21d2; <tt><span class='object_link'><a href="" title="SmsPolicyCheckerService (class)">SmsPolicyCheckerService</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Initializes a new instance of the SmsPolicyCheckerService.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>message_body</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The SMS message content to be analyzed.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


45
46
47
48
49
50
51
52
53</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 45</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_message_body'>message_body</span><span class='rparen'>)</span>
  <span class='ivar'>@message_body</span> <span class='op'>=</span> <span class='id identifier rubyid_message_body'>message_body</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='comment'># Ensure it&#39;s a string
</span>  <span class='ivar'>@message_analysis_report</span> <span class='op'>=</span> <span class='id identifier rubyid_initialize_report'>initialize_report</span>
  <span class='ivar'>@pre_fetched_api_signals</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
  <span class='comment'># Note: Client instances (SafeBrowse, NlClient, GeminiClient) are created on-demand in methods.
</span>  <span class='comment'># Consider memoized accessors if performance profiling indicates instantiation is a bottleneck
</span>  <span class='comment'># or if a single client instance needs to be shared across multiple method calls within
</span>  <span class='comment'># a single `SmsPolicyCheckerService` instance&#39;s lifecycle.
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>

  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id="message_analysis_report=-instance_method"></span>
      <div class="method_details first">
  <h3 class="signature first" id="message_analysis_report-instance_method">
  
    #<strong>message_analysis_report</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the value of attribute message_analysis_report.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


40
41
42</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 40</span>

<span class='kw'>def</span> <span class='id identifier rubyid_message_analysis_report'>message_analysis_report</span>
  <span class='ivar'>@message_analysis_report</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="message_body-instance_method">
  
    #<strong>message_body</strong>  &#x21d2; <tt>Object</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the value of attribute message_body.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


39
40
41</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 39</span>

<span class='kw'>def</span> <span class='id identifier rubyid_message_body'>message_body</span>
  <span class='ivar'>@message_body</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="pre_fetched_api_signals-instance_method">
  
    #<strong>pre_fetched_api_signals</strong>  &#x21d2; <tt>Object</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the value of attribute pre_fetched_api_signals.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


39
40
41</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 39</span>

<span class='kw'>def</span> <span class='id identifier rubyid_pre_fetched_api_signals'>pre_fetched_api_signals</span>
  <span class='ivar'>@pre_fetched_api_signals</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="call-class_method">
  
    .<strong>call</strong>(message_body)  &#x21d2; <tt>Hash</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Class-level convenience method to instantiate and call the service.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>message_body</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The SMS message content to be analyzed.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The analysis report. See <span class='object_link'><a href="#call-instance_method" title="SmsPolicyCheckerService#call (method)">#call</a></span> for details on the report structure.</p>
</div>
      
    </li>
  
</ul>

  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><span class='object_link'><a href="#call-instance_method" title="SmsPolicyCheckerService#call (method)">#call</a></span></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


60
61
62</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 60</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_message_body'>message_body</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_message_body'>message_body</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="add_l1_violation_detail-instance_method">
  
    #<strong>add_l1_violation_detail</strong>(rule, matched_value)  &#x21d2; <tt>void</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Adds a violation detail entry to the report for a Layer 1 rule match. Also updates the maximum score for the associated policy category.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>rule</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The Layer 1 rule configuration hash that was matched. Expected keys: “name”, “description”, “individual_confidence”, “mapped_policy_category”.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>matched_value</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The portion of the message body that matched the rule’s pattern.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


187
188
189
190
191
192
193
194
195
196
197
198</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 187</span>

<span class='kw'>def</span> <span class='id identifier rubyid_add_l1_violation_detail'>add_l1_violation_detail</span><span class='lparen'>(</span><span class='id identifier rubyid_rule'>rule</span><span class='comma'>,</span> <span class='id identifier rubyid_matched_value'>matched_value</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_category'>category</span> <span class='op'>=</span> <span class='id identifier rubyid_rule'>rule</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>mapped_policy_category</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
  <span class='id identifier rubyid_current_score'>current_score</span> <span class='op'>=</span> <span class='id identifier rubyid_rule'>rule</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>individual_confidence</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
  <span class='id identifier rubyid_detail'>detail</span> <span class='op'>=</span> <span class='lbrace'>{</span>
    <span class='label'>layer:</span> <span class='int'>1</span><span class='comma'>,</span> <span class='label'>filter_type:</span> <span class='id identifier rubyid_rule'>rule</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>name</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span> <span class='label'>description:</span> <span class='id identifier rubyid_rule'>rule</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>description</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span>
    <span class='label'>matched_value:</span> <span class='id identifier rubyid_matched_value'>matched_value</span><span class='comma'>,</span> <span class='label'>individual_confidence:</span> <span class='id identifier rubyid_current_score'>current_score</span><span class='comma'>,</span>
    <span class='label'>policy_category:</span> <span class='id identifier rubyid_category'>category</span>
  <span class='rbrace'>}</span>
  <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:violation_details</span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_detail'>detail</span>
  <span class='id identifier rubyid_existing_score'>existing_score</span> <span class='op'>=</span> <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:policy_category_scores</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_category'>category</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
  <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:policy_category_scores</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_category'>category</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_existing_score'>existing_score</span><span class='comma'>,</span> <span class='id identifier rubyid_current_score'>current_score</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_max'>max</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="add_l2_violation_detail-instance_method">
  
    #<strong>add_l2_violation_detail</strong>(characteristic_name, rationale, confidence)  &#x21d2; <tt>void</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Adds a detail entry to the report for a Layer 2 LLM characteristic evaluation. Also updates the maximum score for that characteristic in policy_category_scores.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>characteristic_name</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The name of the policy characteristic evaluated.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>rationale</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The rationale provided by the LLM for its assessment.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>confidence</span>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The confidence score (0.0-1.0+) provided by the LLM.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


545
546
547
548
549
550
551
552
553
554
555</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 545</span>

<span class='kw'>def</span> <span class='id identifier rubyid_add_l2_violation_detail'>add_l2_violation_detail</span><span class='lparen'>(</span><span class='id identifier rubyid_characteristic_name'>characteristic_name</span><span class='comma'>,</span> <span class='id identifier rubyid_rationale'>rationale</span><span class='comma'>,</span> <span class='id identifier rubyid_confidence'>confidence</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_detail'>detail</span> <span class='op'>=</span> <span class='lbrace'>{</span>
    <span class='label'>layer:</span> <span class='int'>2</span><span class='comma'>,</span> <span class='label'>filter_type:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Gemini:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_characteristic_name'>characteristic_name</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='label'>description:</span> <span class='id identifier rubyid_rationale'>rationale</span><span class='comma'>,</span> <span class='label'>matched_value:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>N/A</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='comment'># Matched value is not applicable for L2 in the same way as L1
</span>    <span class='label'>individual_confidence:</span> <span class='id identifier rubyid_confidence'>confidence</span><span class='comma'>,</span> <span class='label'>policy_category:</span> <span class='id identifier rubyid_characteristic_name'>characteristic_name</span>
  <span class='rbrace'>}</span>
  <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:violation_details</span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_detail'>detail</span>
  <span class='id identifier rubyid_existing_score'>existing_score</span> <span class='op'>=</span> <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:policy_category_scores</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_characteristic_name'>characteristic_name</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
  <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:policy_category_scores</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_characteristic_name'>characteristic_name</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_existing_score'>existing_score</span><span class='comma'>,</span> <span class='id identifier rubyid_confidence'>confidence</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_max'>max</span>
  <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService L2_SCORES] Updated score for &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_characteristic_name'>characteristic_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; to: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:policy_category_scores</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_characteristic_name'>characteristic_name</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="add_rewrite_suggestion_if_applicable-instance_method">
  
    #<strong>add_rewrite_suggestion_if_applicable</strong>  &#x21d2; <tt>void</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Adds a rewrite suggestion to the report if the message failed in full analysis mode.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


696
697
698
699
700
701
702
703
704</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 696</span>

<span class='kw'>def</span> <span class='id identifier rubyid_add_rewrite_suggestion_if_applicable'>add_rewrite_suggestion_if_applicable</span>
  <span class='kw'>if</span> <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:result</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='symbol'>:fail</span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:processing_mode</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='symbol'>:full_analysis</span>
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService REWRITE] Message failed in full_analysis, attempting rewrite suggestion.</span><span class='tstring_end'>&quot;</span></span>
    <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:rewrite_suggestion</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_generate_rewrite_suggestion'>generate_rewrite_suggestion</span>
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService REWRITE] Rewrite suggestion result: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:rewrite_suggestion</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='period'>.</span><span class='id identifier rubyid_truncate'>truncate</span><span class='lparen'>(</span><span class='int'>200</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>else</span>
    <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:rewrite_suggestion</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="build_gemini_prompt-instance_method">
  
    #<strong>build_gemini_prompt</strong>(characteristic_config, pre_fetched_signals)  &#x21d2; <tt>String</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Constructs the prompt to be sent to the Gemini LLM for a specific policy characteristic. It uses a template from the characteristic’s configuration and populates placeholders with the message body and summaries of pre-fetched API signals.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>characteristic_config</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The configuration for the LLM characteristic. Expected keys: “prompt_template”, “name”, “knowledge_source_context”.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>pre_fetched_signals</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>A hash containing data gathered by <span class='object_link'><a href="#gather_auxiliary_api_signals-instance_method" title="SmsPolicyCheckerService#gather_auxiliary_api_signals (method)">#gather_auxiliary_api_signals</a></span>. Expected keys: ‘:urls_present`, `:safe_browse_result`, `:nl_api_result`, `:moderation_result`.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The fully constructed prompt text.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 346</span>

<span class='kw'>def</span> <span class='id identifier rubyid_build_gemini_prompt'>build_gemini_prompt</span><span class='lparen'>(</span><span class='id identifier rubyid_characteristic_config'>characteristic_config</span><span class='comma'>,</span> <span class='id identifier rubyid_pre_fetched_signals'>pre_fetched_signals</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_template'>template</span> <span class='op'>=</span> <span class='id identifier rubyid_characteristic_config'>characteristic_config</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>prompt_template</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
  <span class='id identifier rubyid_placeholders'>placeholders</span> <span class='op'>=</span> <span class='lbrace'>{</span>
    <span class='label'>message_body:</span> <span class='ivar'>@message_body</span><span class='comma'>,</span> <span class='comment'># Already ensured to be a string
</span>    <span class='label'>characteristic_name:</span> <span class='id identifier rubyid_characteristic_config'>characteristic_config</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>name</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span>
    <span class='label'>policy_context_snippet:</span> <span class='id identifier rubyid_characteristic_config'>characteristic_config</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>knowledge_source_context</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span>
    <span class='label'>safe_browse_results:</span> <span class='id identifier rubyid_summarize_safe_browse_for_prompt'>summarize_safe_browse_for_prompt</span><span class='lparen'>(</span><span class='id identifier rubyid_pre_fetched_signals'>pre_fetched_signals</span><span class='rparen'>)</span><span class='comma'>,</span>
    <span class='label'>nl_entities:</span> <span class='id identifier rubyid_summarize_nl_entities_for_prompt'>summarize_nl_entities_for_prompt</span><span class='lparen'>(</span><span class='id identifier rubyid_pre_fetched_signals'>pre_fetched_signals</span><span class='rparen'>)</span><span class='comma'>,</span>
    <span class='label'>moderation_signals:</span> <span class='id identifier rubyid_summarize_nl_moderation_for_prompt'>summarize_nl_moderation_for_prompt</span><span class='lparen'>(</span><span class='id identifier rubyid_pre_fetched_signals'>pre_fetched_signals</span><span class='rparen'>)</span><span class='comma'>,</span>
    <span class='label'>perspective_scores:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Perspective API not used; see Text Moderation signals.</span><span class='tstring_end'>&quot;</span></span> <span class='comment'># Static placeholder
</span>  <span class='rbrace'>}</span>

  <span class='id identifier rubyid_prompt'>prompt</span> <span class='op'>=</span> <span class='id identifier rubyid_template'>template</span>
  <span class='id identifier rubyid_placeholders'>placeholders</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='id identifier rubyid_value'>value</span><span class='op'>|</span>
    <span class='id identifier rubyid_prompt'>prompt</span> <span class='op'>=</span> <span class='id identifier rubyid_prompt'>prompt</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>%\{</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_key'>key</span><span class='embexpr_end'>}</span><span class='tstring_content'>\}</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span> <span class='comment'># Ensure value is string
</span>  <span class='kw'>end</span>

  <span class='comment'># This log can be very verbose. Keep at DEBUG or remove if not frequently needed.
</span>  <span class='comment'># Rails.logger.debug &quot;[SmsPolicyCheckerService PROMPT for &#39;#{characteristic_config[&#39;name&#39;]}&#39;] (first 200 chars):\n#{prompt.truncate(200)}&quot;
</span>  <span class='id identifier rubyid_prompt'>prompt</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="call-instance_method">
  
    #<strong>call</strong>  &#x21d2; <tt>Hash</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Executes the full SMS policy checking process. This involves Layer 1 (regex-based) checks and, if applicable, Layer 2 (LLM-based) analysis. It handles fallback logic if API errors occur during Layer 2.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>An analysis report with the following structure:</p>
<ul><li>
<p>‘:result` [Symbol] The overall outcome (`:pass` or `:fail`).</p>
</li><li>
<p>‘:reason` [String] A human-readable reason for the result, often the name of the policy category that led to a failure or “Compliant”.</p>
</li><li>
<p>‘:confidence` [Float] A score (0.0 to 1.0+) indicating the confidence of the most significant finding. Higher values indicate stronger signals.</p>
</li><li>
<p>‘:rewrite_suggestion` [String, Hash, nil] If the message failed and was processed in `:full_analysis` mode, this may contain a rewrite suggestion from the LLM. Can be a string if uncorrectable, or a hash with `general_fix_suggestions` and `literal_rewrite` if correctable.</p>
</li><li>
<p>‘:processing_mode` [Symbol] Indicates the mode of processing (`:full_analysis` or `:fallback_layer1_only`).</p>
</li><li>
<p>‘:policy_category_scores` [Hash&lt;String, Float&gt;] A hash where keys are policy category names (or characteristic names from Layer 2) and values are the highest confidence scores observed for that category.</p>
</li><li>
<p>‘:violation_details` [Array&lt;Hash&gt;] A list of all specific rule matches or LLM characteristic evaluations, each with:</p>
<ul><li>
<p>‘:layer` [Integer] 1 or 2.</p>
</li><li>
<p>‘:filter_type` [String] Name of the L1 rule or “<a href="CharacteristicName">Gemini:</a>” or “<a href="ErrorType">API_FALLBACK:</a>”.</p>
</li><li>
<p>‘:description` [String] Description of the rule or rationale from LLM.</p>
</li><li>
<p>‘:matched_value` [String] The specific text that matched an L1 rule (or “N/A” for L2/fallback).</p>
</li><li>
<p>‘:individual_confidence` [Float] Confidence of this specific detail.</p>
</li><li>
<p>‘:policy_category` [String] The policy category this detail maps to.</p>
</li></ul>
</li></ul>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 92</span>

<span class='kw'>def</span> <span class='id identifier rubyid_call'>call</span>
  <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService CALL] Started. Message snippet: &#39;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@message_body</span><span class='period'>.</span><span class='id identifier rubyid_truncate'>truncate</span><span class='lparen'>(</span><span class='int'>100</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_layer1_halted'>layer1_halted</span> <span class='op'>=</span> <span class='id identifier rubyid_process_layer1_rules'>process_layer1_rules</span>
  <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService CALL] L1 processing done. Halted: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_layer1_halted'>layer1_halted</span><span class='embexpr_end'>}</span><span class='tstring_content'>. Report L1 result: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:result</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_critical_l2_policy_failure_occurred'>critical_l2_policy_failure_occurred</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='kw'>unless</span> <span class='id identifier rubyid_layer1_halted'>layer1_halted</span>
    <span class='kw'>if</span> <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:processing_mode</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='symbol'>:full_analysis</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService CALL] Entering L2 processing.</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_l2_processing_outcome'>l2_processing_outcome</span> <span class='op'>=</span> <span class='id identifier rubyid_process_layer2_llm_analysis'>process_layer2_llm_analysis</span> <span class='comment'># This now gathers API signals internally
</span>      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService CALL] L2 processing outcome: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_l2_processing_outcome'>l2_processing_outcome</span><span class='embexpr_end'>}</span><span class='tstring_content'>.</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_critical_l2_policy_failure_occurred'>critical_l2_policy_failure_occurred</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_l2_processing_outcome'>l2_processing_outcome</span> <span class='op'>==</span> <span class='symbol'>:critical_policy_failure</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService CALL] Skipping L2 because mode is: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:processing_mode</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_determine_final_result_if_not_concluded'>determine_final_result_if_not_concluded</span><span class='lparen'>(</span><span class='id identifier rubyid_layer1_halted'>layer1_halted</span><span class='comma'>,</span> <span class='id identifier rubyid_critical_l2_policy_failure_occurred'>critical_l2_policy_failure_occurred</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_add_rewrite_suggestion_if_applicable'>add_rewrite_suggestion_if_applicable</span>

  <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService CALL] Final report: result: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:result</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>, reason: &#39;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:reason</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;, confidence: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:confidence</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_round'>round</span><span class='lparen'>(</span><span class='int'>3</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>, mode: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:processing_mode</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='ivar'>@message_analysis_report</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="determine_characteristic_relevancy-instance_method">
  
    #<strong>determine_characteristic_relevancy</strong>(char_config)  &#x21d2; <tt>Boolean</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Determines if a given LLM characteristic is relevant for the current message based on “relevancy_skip_conditions” in its configuration. For example, a characteristic related to URL safety might be skipped if no URLs are present in the message.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>char_config</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The configuration hash for the characteristic. May contain a “relevancy_skip_conditions” array.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>‘true` if the characteristic is deemed relevant for processing, `false` if it should be skipped.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


583
584
585
586
587
588
589
590
591
592
593
594
595
596
597
598
599
600
601
602
603
604
605
606
607
608
609
610
611
612
613
614
615</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 583</span>

<span class='kw'>def</span> <span class='id identifier rubyid_determine_characteristic_relevancy'>determine_characteristic_relevancy</span><span class='lparen'>(</span><span class='id identifier rubyid_char_config'>char_config</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_is_relevant'>is_relevant</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='comment'># Default to relevant
</span>  <span class='id identifier rubyid_skip_conditions'>skip_conditions</span> <span class='op'>=</span> <span class='id identifier rubyid_char_config'>char_config</span><span class='period'>.</span><span class='id identifier rubyid_fetch'>fetch</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>relevancy_skip_conditions</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='kw'>true</span> <span class='kw'>unless</span> <span class='id identifier rubyid_skip_conditions'>skip_conditions</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_skip_conditions'>skip_conditions</span><span class='period'>.</span><span class='id identifier rubyid_any?'>any?</span> <span class='comment'># No conditions, so relevant
</span>
  <span class='id identifier rubyid_skip_conditions'>skip_conditions</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_condition'>condition</span><span class='op'>|</span>
    <span class='id identifier rubyid_condition_type'>condition_type</span> <span class='op'>=</span> <span class='id identifier rubyid_condition'>condition</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>type</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_condition_type'>condition_type</span>
    <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>skip_if_no_urls</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_is_relevant'>is_relevant</span> <span class='op'>=</span> <span class='kw'>false</span> <span class='kw'>if</span> <span class='op'>!</span><span class='ivar'>@pre_fetched_api_signals</span><span class='lbracket'>[</span><span class='symbol'>:urls_present</span><span class='rbracket'>]</span> <span class='comment'># Invert logic: skip if no URLs means relevant only if URLs ARE present
</span>      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService RELEVANCY] For &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_char_config'>char_config</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>name</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;: condition &#39;skip_if_no_urls&#39;, urls_present: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@pre_fetched_api_signals</span><span class='lbracket'>[</span><span class='symbol'>:urls_present</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>. Now relevant: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_is_relevant'>is_relevant</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>skip_if_no_specific_entities</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_nl_data'>nl_data</span> <span class='op'>=</span> <span class='ivar'>@pre_fetched_api_signals</span><span class='lbracket'>[</span><span class='symbol'>:nl_api_result</span><span class='rbracket'>]</span>
      <span class='comment'># Only proceed if NL call was successful and entities data is available
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_nl_data'>nl_data</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_nl_data'>nl_data</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>error</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='id identifier rubyid_nl_data'>nl_data</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>error</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_nl_data'>nl_data</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>entities</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_required_entity_type'>required_entity_type</span> <span class='op'>=</span> <span class='id identifier rubyid_condition'>condition</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>entity_type</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_upcase'>upcase</span>
        <span class='id identifier rubyid_found_entities'>found_entities</span> <span class='op'>=</span> <span class='id identifier rubyid_nl_data'>nl_data</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>entities</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_e'>e</span><span class='op'>|</span> <span class='id identifier rubyid_e'>e</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>type</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_upcase'>upcase</span> <span class='op'>==</span> <span class='id identifier rubyid_required_entity_type'>required_entity_type</span> <span class='rbrace'>}</span>
        <span class='id identifier rubyid_is_relevant'>is_relevant</span> <span class='op'>=</span> <span class='kw'>false</span> <span class='kw'>if</span> <span class='id identifier rubyid_found_entities'>found_entities</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='comment'># Skip if no such entities found
</span>        <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService RELEVANCY] For &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_char_config'>char_config</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>name</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;: entity_type &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_required_entity_type'>required_entity_type</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;, found: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_found_entities'>found_entities</span><span class='period'>.</span><span class='id identifier rubyid_any?'>any?</span><span class='embexpr_end'>}</span><span class='tstring_content'>. Now relevant: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_is_relevant'>is_relevant</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>else</span>
        <span class='comment'># If NL data is unavailable, we cannot satisfy a &quot;skip_if_no_specific_entities&quot; condition based on absence.
</span>        <span class='comment'># Defaulting to relevant might be risky if the entity is crucial for the characteristic.
</span>        <span class='comment'># However, if we skip, we might miss violations.
</span>        <span class='comment'># Current behavior: assume relevant if dependent data is missing, as the characteristic might have other signals.
</span>        <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService RELEVANCY] For &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_char_config'>char_config</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>name</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;: Cannot evaluate &#39;skip_if_no_specific_entities&#39; due to NL API data issue. Defaulting to relevant.</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_warn'>warn</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService RELEVANCY] Unknown skip_condition type: &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_condition_type'>condition_type</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; for &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_char_config'>char_config</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>name</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='kw'>break</span> <span class='kw'>unless</span> <span class='id identifier rubyid_is_relevant'>is_relevant</span> <span class='comment'># If any condition makes it irrelevant, stop checking others
</span>  <span class='kw'>end</span>
  <span class='id identifier rubyid_is_relevant'>is_relevant</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="determine_final_result_and_reason-instance_method">
  
    #<strong>determine_final_result_and_reason</strong>  &#x21d2; <tt>void</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>Relies on ‘SmsPolicyCheckerService::THRESHOLDS` constants. It’s expected that these constants are loaded with appropriate numeric values (potentially with defaults) by an initializer.</p>
</div>
  </div>

<p class="note returns_void">This method returns an undefined value.</p>
<p>Calculates the final ‘:result` (:pass or :fail), `:reason`, and `:confidence` for the overall analysis report based on aggregated scores. This is called if no early exit (L1) or critical L2 failure has already determined the outcome. It uses the highest score from `@<a href=":policy_category_scores">message_analysis_report</a>` and compares it against configured thresholds.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


648
649
650
651
652
653
654
655
656
657
658
659
660
661
662
663
664
665
666
667
668
669
670
671
672
673
674
675
676
677
678
679
680
681
682
683
684
685
686
687
688
689
690
691</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 648</span>

<span class='kw'>def</span> <span class='id identifier rubyid_determine_final_result_and_reason'>determine_final_result_and_reason</span>
  <span class='id identifier rubyid_max_observed_score'>max_observed_score</span> <span class='op'>=</span> <span class='float'>0.0</span>
  <span class='id identifier rubyid_leading_category_for_fail'>leading_category_for_fail</span> <span class='op'>=</span> <span class='kw'>nil</span>

  <span class='lparen'>(</span><span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:policy_category_scores</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_category'>category</span><span class='comma'>,</span> <span class='id identifier rubyid_score'>score</span><span class='op'>|</span>
    <span class='id identifier rubyid_score_f'>score_f</span> <span class='op'>=</span> <span class='id identifier rubyid_score'>score</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_score_f'>score_f</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_max_observed_score'>max_observed_score</span>
      <span class='id identifier rubyid_max_observed_score'>max_observed_score</span> <span class='op'>=</span> <span class='id identifier rubyid_score_f'>score_f</span>
      <span class='id identifier rubyid_leading_category_for_fail'>leading_category_for_fail</span> <span class='op'>=</span> <span class='id identifier rubyid_category'>category</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:confidence</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_max_observed_score'>max_observed_score</span>

  <span class='comment'># Assumes THRESHOLDS are loaded by initializer and are Floats.
</span>  <span class='comment'># The initializer should provide defaults if keys are missing from config files.
</span>  <span class='id identifier rubyid_final_threshold_key'>final_threshold_key</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:processing_mode</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='symbol'>:fallback_layer1_only</span>
                          <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>FINAL_THRESHOLD_FLAG_FOR_L1_FALLBACK</span><span class='tstring_end'>&quot;</span></span>
                        <span class='kw'>else</span>
                          <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>FINAL_THRESHOLD_FLAG</span><span class='tstring_end'>&quot;</span></span>
                        <span class='kw'>end</span>
  <span class='id identifier rubyid_threshold_to_use'>threshold_to_use</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="SmsPolicyCheckerService (class)">SmsPolicyCheckerService</a></span></span><span class='op'>::</span><span class='const'>THRESHOLDS</span><span class='lbracket'>[</span><span class='id identifier rubyid_final_threshold_key'>final_threshold_key</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_max_observed_score'>max_observed_score</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_threshold_to_use'>threshold_to_use</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_leading_category_for_fail'>leading_category_for_fail</span>
    <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:result</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='symbol'>:fail</span>
    <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:reason</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:processing_mode</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='symbol'>:fallback_layer1_only</span>
                                          <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Fallback: Layer 1 Threshold Exceeded - Violation Category: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_leading_category_for_fail'>leading_category_for_fail</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
                                        <span class='kw'>else</span>
                                          <span class='id identifier rubyid_leading_category_for_fail'>leading_category_for_fail</span> <span class='comment'># The category itself is the reason
</span>                                        <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='comment'># If result is not already :fail (e.g. from an L1 early exit not caught by the `determine_final_result_if_not_concluded` guard, though unlikely)
</span>    <span class='comment'># or if it&#39;s still the initial :pass state.
</span>    <span class='kw'>if</span> <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:result</span><span class='rbracket'>]</span> <span class='op'>!=</span> <span class='symbol'>:fail</span>
      <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:result</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='symbol'>:pass</span>
      <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:reason</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:processing_mode</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='symbol'>:fallback_layer1_only</span>
                                            <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Fallback: Compliant.</span><span class='tstring_end'>&quot;</span></span>
                                          <span class='kw'>else</span>
                                            <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Compliant</span><span class='tstring_end'>&quot;</span></span>
                                          <span class='kw'>end</span>
      <span class='comment'># Confidence remains max_observed_score, which might be low for a pass, which is fine.
</span>    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService FINAL_RESULT] Based on threshold &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_threshold_to_use'>threshold_to_use</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;: Result: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:result</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>, Reason: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:reason</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>, Score: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_max_observed_score'>max_observed_score</span><span class='period'>.</span><span class='id identifier rubyid_round'>round</span><span class='lparen'>(</span><span class='int'>3</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="determine_final_result_if_not_concluded-instance_method">
  
    #<strong>determine_final_result_if_not_concluded</strong>(layer1_halted, critical_l2_failure_occurred)  &#x21d2; <tt>void</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Determines the final result and reason if not already concluded by L1 early exit or L2 critical failure.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>layer1_halted</span>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Whether Layer 1 processing was halted.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>critical_l2_failure_occurred</span>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Whether a critical L2 policy failure occurred.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


622
623
624
625
626
627
628
629
630
631
632
633
634</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 622</span>

<span class='kw'>def</span> <span class='id identifier rubyid_determine_final_result_if_not_concluded'>determine_final_result_if_not_concluded</span><span class='lparen'>(</span><span class='id identifier rubyid_layer1_halted'>layer1_halted</span><span class='comma'>,</span> <span class='id identifier rubyid_critical_l2_failure_occurred'>critical_l2_failure_occurred</span><span class='rparen'>)</span>
  <span class='comment'># If L1 halted or L2 had a critical failure, the result, reason, and confidence are already set.
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_layer1_halted'>layer1_halted</span>
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService FINAL_RESULT] L1 halted, result already determined: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:reason</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>return</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_critical_l2_failure_occurred'>critical_l2_failure_occurred</span>
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService FINAL_RESULT] Critical L2 failure, result already determined: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:reason</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService FINAL_RESULT] Determining final result based on aggregated scores. Mode: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:processing_mode</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_determine_final_result_and_reason'>determine_final_result_and_reason</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="extract_urls_from_message_body-instance_method">
  
    #<strong>extract_urls_from_message_body</strong>  &#x21d2; <tt>Array&lt;String&gt;</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Extracts all HTTP and HTTPS URLs from the message body.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array&lt;String&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>An array of unique URLs found in the message. Returns an empty array if no URLs are found. Logs an error and returns an empty array if ‘URI.extract` raises an exception or if `message_body` is not suitable for extraction.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 228</span>

<span class='kw'>def</span> <span class='id identifier rubyid_extract_urls_from_message_body'>extract_urls_from_message_body</span>
  <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService EXTRACT_URLS] For: &#39;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@message_body</span><span class='period'>.</span><span class='id identifier rubyid_truncate'>truncate</span><span class='lparen'>(</span><span class='int'>50</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_urls'>urls</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='comment'># URI.extract can be slow or error-prone with very large/malformed strings.
</span>  <span class='comment'># Ensure message_body is a string and not excessively long if performance issues arise.
</span>  <span class='kw'>return</span> <span class='id identifier rubyid_urls'>urls</span> <span class='kw'>unless</span> <span class='ivar'>@message_body</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>String</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@message_body</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&lt;</span> <span class='int'>10_000</span> <span class='comment'># Arbitrary sanity length limit
</span>
  <span class='kw'>begin</span>
    <span class='id identifier rubyid_urls'>urls</span> <span class='op'>=</span> <span class='const'>URI</span><span class='period'>.</span><span class='id identifier rubyid_extract'>extract</span><span class='lparen'>(</span><span class='ivar'>@message_body</span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>https</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_uniq'>uniq</span>
  <span class='kw'>rescue</span> <span class='const'>StandardError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService EXTRACT_URLS] Error during URI.extract: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_content'> for message: &#39;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@message_body</span><span class='period'>.</span><span class='id identifier rubyid_truncate'>truncate</span><span class='lparen'>(</span><span class='int'>50</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_urls'>urls</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span> <span class='comment'># Ensure urls is an empty array on error
</span>  <span class='kw'>end</span>
  <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService EXTRACT_URLS] Found: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_urls'>urls</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_urls'>urls</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="fetch_nl_entities_signals-instance_method">
  
    #<strong>fetch_nl_entities_signals</strong>  &#x21d2; <tt>void</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Fetches entity analysis signals from Google Natural Language API. Stores results or error information in ‘@<a href=":nl_api_result">pre_fetched_api_signals</a>`.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 296</span>

<span class='kw'>def</span> <span class='id identifier rubyid_fetch_nl_entities_signals'>fetch_nl_entities_signals</span>
  <span class='kw'>begin</span>
    <span class='id identifier rubyid_nl_client'>nl_client</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/NlClient.html" title="Google::NlClient (class)">NlClient</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/NlClient.html#initialize-instance_method" title="Google::NlClient#initialize (method)">new</a></span></span>
    <span class='id identifier rubyid_response'>response</span> <span class='op'>=</span> <span class='id identifier rubyid_nl_client'>nl_client</span><span class='period'>.</span><span class='id identifier rubyid_analyze_entities'>analyze_entities</span><span class='lparen'>(</span><span class='ivar'>@message_body</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_response'>response</span><span class='op'>&amp;.</span><span class='id identifier rubyid_dig'>dig</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>error</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='id identifier rubyid_error_message'>error_message</span> <span class='op'>=</span> <span class='id identifier rubyid_response'>response</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>error</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Hash</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_response'>response</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>error</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>message</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>:</span> <span class='id identifier rubyid_response'>response</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>error</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_warn'>warn</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService GATHER_SIGNALS] NlClient#analyze_entities API Error: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error_message'>error_message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='ivar'>@pre_fetched_api_signals</span><span class='lbracket'>[</span><span class='symbol'>:nl_api_result</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>entities</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>error</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[Google::NlClient#analyze_entities] API Error: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error_message'>error_message</span><span class='period'>.</span><span class='id identifier rubyid_truncate'>truncate</span><span class='lparen'>(</span><span class='int'>150</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>languageCode</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>und</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>languageSupported</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>false</span> <span class='rbrace'>}</span>
    <span class='kw'>else</span>
      <span class='ivar'>@pre_fetched_api_signals</span><span class='lbracket'>[</span><span class='symbol'>:nl_api_result</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_response'>response</span> <span class='op'>||</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>entities</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>languageCode</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>und</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>languageSupported</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>false</span> <span class='rbrace'>}</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService GATHER_SIGNALS] NL Entities check done. Entities found: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@pre_fetched_api_signals</span><span class='lbracket'>[</span><span class='symbol'>:nl_api_result</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>entities</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_any?'>any?</span> <span class='op'>||</span> <span class='kw'>false</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>rescue</span> <span class='const'>StandardError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService GATHER_SIGNALS] Google::NlClient#analyze_entities Invocation Error: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'> - </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='ivar'>@pre_fetched_api_signals</span><span class='lbracket'>[</span><span class='symbol'>:nl_api_result</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>entities</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>error</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[Google::NlClient#analyze_entities] Invocation Error: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='period'>.</span><span class='id identifier rubyid_truncate'>truncate</span><span class='lparen'>(</span><span class='int'>100</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>languageCode</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>und</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>languageSupported</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>false</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="fetch_nl_moderation_signals-instance_method">
  
    #<strong>fetch_nl_moderation_signals</strong>  &#x21d2; <tt>void</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Fetches text moderation signals from Google Natural Language API. Stores results or error information in ‘@<a href=":moderation_result">pre_fetched_api_signals</a>`.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 318</span>

<span class='kw'>def</span> <span class='id identifier rubyid_fetch_nl_moderation_signals'>fetch_nl_moderation_signals</span>
  <span class='kw'>begin</span>
    <span class='id identifier rubyid_nl_client'>nl_client</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/NlClient.html" title="Google::NlClient (class)">NlClient</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/NlClient.html#initialize-instance_method" title="Google::NlClient#initialize (method)">new</a></span></span> <span class='comment'># New instance, could be memoized if NlClient is shareable
</span>    <span class='id identifier rubyid_response'>response</span> <span class='op'>=</span> <span class='id identifier rubyid_nl_client'>nl_client</span><span class='period'>.</span><span class='id identifier rubyid_moderate_text'>moderate_text</span><span class='lparen'>(</span><span class='ivar'>@message_body</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_response'>response</span><span class='op'>&amp;.</span><span class='id identifier rubyid_dig'>dig</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>error</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='id identifier rubyid_error_message'>error_message</span> <span class='op'>=</span> <span class='id identifier rubyid_response'>response</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>error</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Hash</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_response'>response</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>error</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>message</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>:</span> <span class='id identifier rubyid_response'>response</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>error</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_warn'>warn</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService GATHER_SIGNALS] NlClient#moderate_text API Error: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error_message'>error_message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='ivar'>@pre_fetched_api_signals</span><span class='lbracket'>[</span><span class='symbol'>:moderation_result</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>moderationCategories</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>error</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[Google::NlClient#moderate_text] API Error: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error_message'>error_message</span><span class='period'>.</span><span class='id identifier rubyid_truncate'>truncate</span><span class='lparen'>(</span><span class='int'>150</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
    <span class='kw'>else</span>
      <span class='ivar'>@pre_fetched_api_signals</span><span class='lbracket'>[</span><span class='symbol'>:moderation_result</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_response'>response</span> <span class='op'>||</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>moderationCategories</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService GATHER_SIGNALS] NL ModerateText check done. Categories found: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@pre_fetched_api_signals</span><span class='lbracket'>[</span><span class='symbol'>:moderation_result</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>moderationCategories</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_any?'>any?</span> <span class='op'>||</span> <span class='kw'>false</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>rescue</span> <span class='const'>StandardError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService GATHER_SIGNALS] Google::NlClient#moderate_text Invocation Error: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'> - </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='ivar'>@pre_fetched_api_signals</span><span class='lbracket'>[</span><span class='symbol'>:moderation_result</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>moderationCategories</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>error</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[Google::NlClient#moderate_text] Invocation Error: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='period'>.</span><span class='id identifier rubyid_truncate'>truncate</span><span class='lparen'>(</span><span class='int'>100</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="fetch_safebrowse_signals-instance_method">
  
    #<strong>fetch_safebrowse_signals</strong>  &#x21d2; <tt>void</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Fetches signals from Google Safe Browse API. Stores results or error information in ‘@<a href=":safe_browse_result">pre_fetched_api_signals</a>`.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 270</span>

<span class='kw'>def</span> <span class='id identifier rubyid_fetch_safebrowse_signals'>fetch_safebrowse_signals</span>
  <span class='kw'>if</span> <span class='ivar'>@pre_fetched_api_signals</span><span class='lbracket'>[</span><span class='symbol'>:urls_present</span><span class='rbracket'>]</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_sb_client'>sb_client</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/SafeBrowseClient.html" title="Google::SafeBrowseClient (class)">SafeBrowseClient</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/SafeBrowseClient.html#initialize-instance_method" title="Google::SafeBrowseClient#initialize (method)">new</a></span></span>
      <span class='id identifier rubyid_response'>response</span> <span class='op'>=</span> <span class='id identifier rubyid_sb_client'>sb_client</span><span class='period'>.</span><span class='id identifier rubyid_find_threat_matches'>find_threat_matches</span><span class='lparen'>(</span><span class='ivar'>@pre_fetched_api_signals</span><span class='lbracket'>[</span><span class='symbol'>:url_list</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_response'>response</span><span class='op'>&amp;.</span><span class='id identifier rubyid_dig'>dig</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>error</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
        <span class='id identifier rubyid_error_message'>error_message</span> <span class='op'>=</span> <span class='id identifier rubyid_response'>response</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>error</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Hash</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_response'>response</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>error</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>message</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>:</span> <span class='id identifier rubyid_response'>response</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>error</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
        <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_warn'>warn</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService GATHER_SIGNALS] SafeBrowseClient#find_threat_matches API Error: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error_message'>error_message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
        <span class='ivar'>@pre_fetched_api_signals</span><span class='lbracket'>[</span><span class='symbol'>:safe_browse_result</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>matches</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>error</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[Google::SafeBrowseClient#find_threat_matches] API Error: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error_message'>error_message</span><span class='period'>.</span><span class='id identifier rubyid_truncate'>truncate</span><span class='lparen'>(</span><span class='int'>150</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
      <span class='kw'>else</span>
        <span class='ivar'>@pre_fetched_api_signals</span><span class='lbracket'>[</span><span class='symbol'>:safe_browse_result</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_response'>response</span> <span class='op'>||</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>matches</span><span class='label_end'>&quot;:</span> <span class='lbracket'>[</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
        <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService GATHER_SIGNALS] SafeBrowse check done. Matches found: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@pre_fetched_api_signals</span><span class='lbracket'>[</span><span class='symbol'>:safe_browse_result</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>matches</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_any?'>any?</span> <span class='op'>||</span> <span class='kw'>false</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>rescue</span> <span class='const'>StandardError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService GATHER_SIGNALS] Google::SafeBrowseClient#find_threat_matches Invocation Error: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'> - </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='ivar'>@pre_fetched_api_signals</span><span class='lbracket'>[</span><span class='symbol'>:safe_browse_result</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>matches</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>error</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[Google::SafeBrowseClient#find_threat_matches] Invocation Error: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='period'>.</span><span class='id identifier rubyid_truncate'>truncate</span><span class='lparen'>(</span><span class='int'>100</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='ivar'>@pre_fetched_api_signals</span><span class='lbracket'>[</span><span class='symbol'>:safe_browse_result</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>matches</span><span class='label_end'>&quot;:</span> <span class='lbracket'>[</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="gather_auxiliary_api_signals-instance_method">
  
    #<strong>gather_auxiliary_api_signals</strong>  &#x21d2; <tt>void</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>This method makes network calls to external services.</p>
</div>
  </div>

<p class="note returns_void">This method returns an undefined value.</p>
<p>Collects signals from auxiliary APIs (Safe Browse, Natural Language API for entities and moderation). The results, or error information if calls fail, are stored in ‘@pre_fetched_api_signals`. If any client instantiation or call fails catastrophically (raises an exception), an error hash is stored for that signal.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


253
254
255
256
257
258
259
260
261
262
263
264</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 253</span>

<span class='kw'>def</span> <span class='id identifier rubyid_gather_auxiliary_api_signals'>gather_auxiliary_api_signals</span>
  <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService GATHER_SIGNALS] Starting.</span><span class='tstring_end'>&quot;</span></span>
  <span class='ivar'>@pre_fetched_api_signals</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span> <span class='comment'># Reset pre_fetched_api_signals
</span>  <span class='ivar'>@pre_fetched_api_signals</span><span class='lbracket'>[</span><span class='symbol'>:url_list</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_extract_urls_from_message_body'>extract_urls_from_message_body</span>
  <span class='ivar'>@pre_fetched_api_signals</span><span class='lbracket'>[</span><span class='symbol'>:urls_present</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='ivar'>@pre_fetched_api_signals</span><span class='lbracket'>[</span><span class='symbol'>:url_list</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_any?'>any?</span>

  <span class='id identifier rubyid_fetch_safebrowse_signals'>fetch_safebrowse_signals</span>
  <span class='id identifier rubyid_fetch_nl_entities_signals'>fetch_nl_entities_signals</span>
  <span class='id identifier rubyid_fetch_nl_moderation_signals'>fetch_nl_moderation_signals</span>

  <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService GATHER_SIGNALS] Finished. Signals: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@pre_fetched_api_signals</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="generate_rewrite_suggestion-instance_method">
  
    #<strong>generate_rewrite_suggestion</strong>  &#x21d2; <tt>String</tt>, ...  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>Makes a network call to the Gemini client.</p>
</div>
  </div>


<p>Attempts to generate a rewrite suggestion for a failing message using the Gemini LLM. This is only called if the message analysis resulted in a ‘:fail` and was processed in `:full_analysis` mode.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>, <tt>Hash</tt>, <tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><ul><li>
<p>A [String] message if the LLM deems the content uncorrectable (e.g., “This message cannot be made compliant due to:…”).</p>
</li><li>
<p>A [Hash] with keys ‘“general_fix_suggestions”` (String) and `“literal_rewrite”` (String) if the LLM provides a structured suggestion.</p>
</li><li>
<p>‘nil` if a rewrite is not applicable, if necessary data is missing, if the Gemini client returns an error, or if an unexpected exception occurs during the process.</p>
</li></ul>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


756
757
758
759
760
761
762
763
764
765
766
767
768
769
770
771
772
773
774
775
776
777
778
779
780
781
782
783
784
785
786
787
788</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 756</span>

<span class='kw'>def</span> <span class='id identifier rubyid_generate_rewrite_suggestion'>generate_rewrite_suggestion</span>
  <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService REWRITE] Generating rewrite suggestion.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>unless</span> <span class='ivar'>@message_body</span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:reason</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:confidence</span><span class='rbracket'>]</span>
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_warn'>warn</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService REWRITE] Missing necessary data (message, reason, or confidence) for rewrite.</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>return</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_gemini_client'>gemini_client</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/GeminiClient.html" title="Google::GeminiClient (class)">GeminiClient</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/GeminiClient.html#initialize-instance_method" title="Google::GeminiClient#initialize (method)">new</a></span></span> <span class='comment'># Consider memoization
</span>  <span class='id identifier rubyid_rewrite_response'>rewrite_response</span> <span class='op'>=</span> <span class='id identifier rubyid_gemini_client'>gemini_client</span><span class='period'>.</span><span class='id identifier rubyid_generate_rewrite'>generate_rewrite</span><span class='lparen'>(</span>
    <span class='ivar'>@message_body</span><span class='comma'>,</span>
    <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:reason</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='comment'># The primary failing category/characteristic
</span>    <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:confidence</span><span class='rbracket'>]</span>
  <span class='rparen'>)</span>

  <span class='comment'># Check for specific structured responses from GeminiClient for rewrites
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_rewrite_response'>rewrite_response</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>String</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_rewrite_response'>rewrite_response</span><span class='period'>.</span><span class='id identifier rubyid_start_with?'>start_with?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>This message cannot be made compliant due to:</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService REWRITE] LLM deemed message uncorrectable: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_rewrite_response'>rewrite_response</span><span class='period'>.</span><span class='id identifier rubyid_truncate'>truncate</span><span class='lparen'>(</span><span class='int'>100</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_rewrite_response'>rewrite_response</span> <span class='comment'># Return the string explaining why it&#39;s uncorrectable
</span>  <span class='kw'>elsif</span> <span class='id identifier rubyid_rewrite_response'>rewrite_response</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Hash</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_rewrite_response'>rewrite_response</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>literal_rewrite</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> <span class='comment'># Assuming &quot;literal_rewrite&quot; is key
</span>    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService REWRITE] LLM provided correctable suggestions.</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_rewrite_response'>rewrite_response</span> <span class='comment'># Return the hash with suggestions
</span>  <span class='kw'>elsif</span> <span class='id identifier rubyid_rewrite_response'>rewrite_response</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Hash</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_rewrite_response'>rewrite_response</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>error</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_error_details'>error_details</span> <span class='op'>=</span> <span class='id identifier rubyid_rewrite_response'>rewrite_response</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>details</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='id identifier rubyid_rewrite_response'>rewrite_response</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>error</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService REWRITE] GeminiClient error during rewrite generation: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_rewrite_response'>rewrite_response</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>error</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>. Details: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error_details'>error_details</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_truncate'>truncate</span><span class='lparen'>(</span><span class='int'>200</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>nil</span> <span class='comment'># Error from client
</span>  <span class='kw'>else</span>
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_warn'>warn</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService REWRITE] LLM returned an unexpected format for rewrite: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_rewrite_response'>rewrite_response</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='period'>.</span><span class='id identifier rubyid_truncate'>truncate</span><span class='lparen'>(</span><span class='int'>300</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>nil</span> <span class='comment'># Unexpected format
</span>  <span class='kw'>end</span>
<span class='kw'>rescue</span> <span class='const'>StandardError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span> <span class='comment'># Catches exceptions from GeminiClient instantiation or other unexpected errors
</span>  <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService REWRITE] Exception during generate_rewrite_suggestion: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'> - </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_content'>. Backtrace: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_backtrace'>backtrace</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='lparen'>(</span><span class='int'>3</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'> | </span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>nil</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="handle_api_errors_and_fallback-instance_method">
  
    #<strong>handle_api_errors_and_fallback</strong>(error_type, options = {})  &#x21d2; <tt>void</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Manages the transition to ‘:fallback_layer1_only` processing mode when a significant API error occurs during Layer 2. It updates the report’s processing mode and adds a specific violation detail indicating the fallback.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>error_type</span>
      
      
        <span class='type'>(<tt>Symbol</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>A symbol identifying the type of API error (e.g., ‘:gemini_call_failed`, `:gemini_response_malformed`).</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>options</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>{}</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Additional context about the error.</p>
</div>
      
    </li>
  
</ul>

  
    
    
    
    
    <p class="tag_title">Options Hash (<tt>options</tt>):</p>
    <ul class="option">
      
        <li>
          <span class="name">:characteristic_name</span>
          <span class="type">(<tt>String</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>The name of the characteristic being processed when the error occurred.</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:error_message</span>
          <span class="type">(<tt>String</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>The specific error message from the client or system.</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:response</span>
          <span class="type">(<tt>String</tt>)</span>
          <span class="default">
            
              &mdash; default:
              <tt>optional</tt>
            
          </span>
          
            &mdash; <div class='inline'>
<p>The raw response that was malformed.</p>
</div>
          
        </li>
      
    </ul>
  


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


718
719
720
721
722
723
724
725
726
727
728
729
730
731
732
733
734
735
736
737
738
739
740
741
742</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 718</span>

<span class='kw'>def</span> <span class='id identifier rubyid_handle_api_errors_and_fallback'>handle_api_errors_and_fallback</span><span class='lparen'>(</span><span class='id identifier rubyid_error_type'>error_type</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='comment'># Prevent multiple fallbacks or fallback if already in that mode
</span>  <span class='kw'>return</span> <span class='kw'>if</span> <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:processing_mode</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='symbol'>:fallback_layer1_only</span>

  <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_warn'>warn</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService FALLBACK] API Error triggering fallback. Type: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error_type'>error_type</span><span class='embexpr_end'>}</span><span class='tstring_content'>, Options: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_options'>options</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:processing_mode</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='symbol'>:fallback_layer1_only</span>
  <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:rewrite_suggestion</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>nil</span> <span class='comment'># No rewrites in fallback mode
</span>
  <span class='id identifier rubyid_char_name_info'>char_name_info</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:characteristic_name</span><span class='rbracket'>]</span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> for characteristic &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:characteristic_name</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;</span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> during general L2 processing</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_error_detail_msg'>error_detail_msg</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:error_message</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>L2 API processing encountered an issue.</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_description'>description</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Switched to Layer 1 fallback mode due to API error: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error_type'>error_type</span><span class='embexpr_end'>}</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_char_name_info'>char_name_info</span><span class='embexpr_end'>}</span><span class='tstring_content'>. Detail: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error_detail_msg'>error_detail_msg</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='period'>.</span><span class='id identifier rubyid_strip'>strip</span>
  <span class='id identifier rubyid_api_failure_detail'>api_failure_detail</span> <span class='op'>=</span> <span class='lbrace'>{</span>
    <span class='label'>layer:</span> <span class='int'>2</span><span class='comma'>,</span> <span class='comment'># Error occurred in context of Layer 2
</span>    <span class='label'>filter_type:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>API_FALLBACK:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error_type'>error_type</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='label'>description:</span> <span class='id identifier rubyid_description'>description</span><span class='period'>.</span><span class='id identifier rubyid_truncate'>truncate</span><span class='lparen'>(</span><span class='int'>300</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='comment'># Ensure description is not excessively long
</span>    <span class='label'>matched_value:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>N/A</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='label'>individual_confidence:</span> <span class='float'>0.0</span><span class='comma'>,</span> <span class='comment'># No confidence score for an API error itself
</span>    <span class='label'>policy_category:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>API_Error</span><span class='tstring_end'>&quot;</span></span>
  <span class='rbrace'>}</span>
  <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:violation_details</span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_api_failure_detail'>api_failure_detail</span>
  <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_warn'>warn</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService FALLBACK] Switched to :fallback_layer1_only mode. Report will be based on L1 scores and L1 final threshold.</span><span class='tstring_end'>&quot;</span></span>
  <span class='comment'># Note: The final result and reason will be re-evaluated based on L1 scores by determine_final_result_and_reason
</span>  <span class='comment'># if this fallback happens before that stage. If it happens mid-determine_final_result, that method will use the L1 fallback threshold.
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="initialize_report-instance_method">
  
    #<strong>initialize_report</strong>  &#x21d2; <tt>Hash</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Initializes the structure for the analysis report.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>A hash with default values for the analysis report. See <span class='object_link'><a href="#call-instance_method" title="SmsPolicyCheckerService#call (method)">#call</a></span> return value for the keys initialized here.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


123
124
125
126
127
128
129</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 123</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize_report'>initialize_report</span>
  <span class='lbrace'>{</span>
    <span class='label'>result:</span> <span class='symbol'>:pass</span><span class='comma'>,</span> <span class='label'>reason:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Compliant</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>confidence:</span> <span class='float'>0.0</span><span class='comma'>,</span>
    <span class='label'>rewrite_suggestion:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>processing_mode:</span> <span class='symbol'>:full_analysis</span><span class='comma'>,</span>
    <span class='label'>policy_category_scores:</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='label'>violation_details:</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="process_layer1_rules-instance_method">
  
    #<strong>process_layer1_rules</strong>  &#x21d2; <tt>Boolean</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>Relies on ‘SmsPolicyCheckerService::LAYER1_RULES` constant being loaded and correctly formatted.</p>
</div>
  </div>


<p>Processes the message against Layer 1 rules (typically regex-based). It populates violation details and policy category scores in the ‘@message_analysis_report`. If an “early exit” rule is met with sufficient confidence, it sets the report to fail and halts further Layer 1 processing.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>‘true` if processing was halted due to an early exit rule, `false` otherwise.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 142</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process_layer1_rules'>process_layer1_rules</span>
  <span class='kw'>unless</span> <span class='kw'>defined?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="" title="SmsPolicyCheckerService (class)">SmsPolicyCheckerService</a></span></span><span class='op'>::</span><span class='const'>LAYER1_RULES</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='const'><span class='object_link'><a href="" title="SmsPolicyCheckerService (class)">SmsPolicyCheckerService</a></span></span><span class='op'>::</span><span class='const'>LAYER1_RULES</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span>
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService L1] CRITICAL: LAYER1_RULES not loaded or not an array. Skipping Layer 1.</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>return</span> <span class='kw'>false</span> <span class='comment'># No rules to process, so not halted by a rule.
</span>  <span class='kw'>end</span>

  <span class='id identifier rubyid_processing_halted'>processing_halted</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='const'><span class='object_link'><a href="" title="SmsPolicyCheckerService (class)">SmsPolicyCheckerService</a></span></span><span class='op'>::</span><span class='const'>LAYER1_RULES</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_rule'>rule</span><span class='op'>|</span>
    <span class='comment'># Config integrity check: ensure compiled_patterns is an array
</span>    <span class='kw'>unless</span> <span class='id identifier rubyid_rule'>rule</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>compiled_patterns</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_warn'>warn</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService L1] Skipping rule &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_rule'>rule</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>name</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; due to missing or invalid &#39;compiled_patterns&#39;.</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>next</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_rule'>rule</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>compiled_patterns</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_pattern'>pattern</span><span class='op'>|</span>
      <span class='comment'># Config integrity check: ensure pattern is a Regexp
</span>      <span class='kw'>unless</span> <span class='id identifier rubyid_pattern'>pattern</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Regexp</span><span class='rparen'>)</span>
        <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_warn'>warn</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService L1] Skipping invalid pattern in rule &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_rule'>rule</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>name</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; (not a Regexp).</span><span class='tstring_end'>&quot;</span></span>
        <span class='kw'>next</span>
      <span class='kw'>end</span>

      <span class='comment'># Assignment in condition is intentional for efficiency (matching can be frequent)
</span>      <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_match_data'>match_data</span> <span class='op'>=</span> <span class='id identifier rubyid_pattern'>pattern</span><span class='period'>.</span><span class='id identifier rubyid_match'>match</span><span class='lparen'>(</span><span class='ivar'>@message_body</span><span class='rparen'>)</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_add_l1_violation_detail'>add_l1_violation_detail</span><span class='lparen'>(</span><span class='id identifier rubyid_rule'>rule</span><span class='comma'>,</span> <span class='id identifier rubyid_match_data'>match_data</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='rparen'>)</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_rule'>rule</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>is_early_exit_rule</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_rule'>rule</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>individual_confidence</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_rule'>rule</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>early_exit_threshold</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
          <span class='id identifier rubyid_set_early_exit_failure'>set_early_exit_failure</span><span class='lparen'>(</span><span class='id identifier rubyid_rule'>rule</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_processing_halted'>processing_halted</span> <span class='op'>=</span> <span class='kw'>true</span>
          <span class='kw'>break</span> <span class='comment'># Stop processing patterns for this rule
</span>        <span class='kw'>end</span>
        <span class='kw'>break</span> <span class='comment'># Stop processing patterns for this rule as one has matched
</span>      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='kw'>break</span> <span class='kw'>if</span> <span class='id identifier rubyid_processing_halted'>processing_halted</span> <span class='comment'># Stop processing further rules if halted
</span>  <span class='kw'>end</span>
  <span class='id identifier rubyid_processing_halted'>processing_halted</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="process_layer2_llm_analysis-instance_method">
  
    #<strong>process_layer2_llm_analysis</strong>  &#x21d2; <tt>Symbol</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>Relies on ‘SmsPolicyCheckerService::LLM_CONFIG` and `SmsPolicyCheckerService::CRITICAL_FAILURE_THRESHOLDS` constants.</p>
</div>
  </div>


<p>Manages the Layer 2 analysis using the Gemini LLM for various policy characteristics. It first gathers auxiliary API signals. Then, for each relevant characteristic, it builds a prompt, calls the Gemini client, and processes the response. If critical API errors occur (e.g., Gemini call failure or malformed response), it triggers a fallback to Layer 1 only processing. If a characteristic evaluation meets a critical failure threshold, processing stops and a critical policy failure is recorded.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Symbol</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><ul><li>
<p>‘:ok` if L2 processing completed without critical LLM failures or API errors forcing fallback.</p>
</li><li>
<p>‘:api_error_triggered_fallback` if an API error caused a switch to `:fallback_layer1_only` mode.</p>
</li><li>
<p>‘:critical_policy_failure` if an LLM evaluation exceeded a critical threshold for a characteristic.</p>
</li></ul>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 444</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process_layer2_llm_analysis'>process_layer2_llm_analysis</span>
  <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService L2_PROCESS] Starting Layer 2 analysis.</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_gather_auxiliary_api_signals'>gather_auxiliary_api_signals</span> <span class='comment'># Gather fresh signals for L2
</span>
  <span class='comment'># If API signal gathering itself led to a fallback scenario (e.g., via a yet-to-be-implemented global error handler)
</span>  <span class='kw'>return</span> <span class='symbol'>:api_error_triggered_fallback</span> <span class='kw'>if</span> <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:processing_mode</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='symbol'>:fallback_layer1_only</span>

  <span class='id identifier rubyid_all_characteristics'>all_characteristics</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="SmsPolicyCheckerService (class)">SmsPolicyCheckerService</a></span></span><span class='op'>::</span><span class='const'>LLM_CONFIG</span><span class='op'>&amp;.</span><span class='id identifier rubyid_fetch'>fetch</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>characteristics</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>unless</span> <span class='id identifier rubyid_all_characteristics'>all_characteristics</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_all_characteristics'>all_characteristics</span><span class='period'>.</span><span class='id identifier rubyid_any?'>any?</span>
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_warn'>warn</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService L2_PROCESS] No LLM characteristics configured or LLM_CONFIG is invalid. Skipping L2.</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>return</span> <span class='symbol'>:ok</span> <span class='comment'># No characteristics to process.
</span>  <span class='kw'>end</span>

  <span class='comment'># Defines the specific set of policy characteristics to be evaluated by the LLM.
</span>  <span class='comment'># These characteristics are based on the defined scope of policy coverage for this service.
</span>  <span class='comment'># TODO: Consider if this list should be dynamically derived from config or remain hardcoded for this specific service&#39;s scope.
</span>  <span class='id identifier rubyid_characteristics_to_process_names'>characteristics_to_process_names</span> <span class='op'>=</span> <span class='lbracket'>[</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MisleadingSenderIdentity</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>FalseOrInaccurateContent</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>HatefulContent</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ServiceInterferenceOrFilterEvasion</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>SHAFT_Sex_AdultContent</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>SHAFT_Alcohol_ProhibitedPromotion</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>SHAFT_Firearms_IllegalPromotion</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>SHAFT_Tobacco_ProhibitedPromotion</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ProhibitedSubstances_CannabisCBDKratom</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>RegulatedPharmaceuticals_PrescriptionOffers</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>FraudulentOrMaliciousContent</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>HighRiskFinancialServices</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ProhibitedAffiliateMarketing</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>RestrictedDebtCollection</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>GetRichQuickSchemes</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>GamblingPromotions</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>PhishingAndDeceptiveURLs</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ProhibitedPublicURLShorteners</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>AdvancedContentEvasionTactics</span><span class='tstring_end'>&quot;</span></span>
  <span class='rbracket'>]</span>
  <span class='id identifier rubyid_characteristics_to_evaluate'>characteristics_to_evaluate</span> <span class='op'>=</span> <span class='id identifier rubyid_all_characteristics'>all_characteristics</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span> <span class='id identifier rubyid_characteristics_to_process_names'>characteristics_to_process_names</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>name</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span> <span class='rbrace'>}</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_characteristics_to_evaluate'>characteristics_to_evaluate</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService L2_PROCESS] No applicable characteristics found for evaluation after filtering.</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>return</span> <span class='symbol'>:ok</span>
  <span class='kw'>end</span>

  <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService L2_PROCESS] Will evaluate </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_characteristics_to_evaluate'>characteristics_to_evaluate</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='embexpr_end'>}</span><span class='tstring_content'> L2 characteristics.</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_gemini_client'>gemini_client</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/GeminiClient.html" title="Google::GeminiClient (class)">GeminiClient</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/GeminiClient.html#initialize-instance_method" title="Google::GeminiClient#initialize (method)">new</a></span></span> <span class='comment'># Consider memoization
</span>
  <span class='id identifier rubyid_characteristics_to_evaluate'>characteristics_to_evaluate</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_char_config'>char_config</span><span class='op'>|</span>
    <span class='comment'># Check for fallback mode at the start of each characteristic processing
</span>    <span class='kw'>if</span> <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:processing_mode</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='symbol'>:fallback_layer1_only</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_warn'>warn</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService L2_PROCESS] Fallback triggered mid-loop. Stopping further L2 characteristic processing.</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>return</span> <span class='symbol'>:api_error_triggered_fallback</span> <span class='comment'># Exit L2 processing loop
</span>    <span class='kw'>end</span>

    <span class='id identifier rubyid_outcome'>outcome</span> <span class='op'>=</span> <span class='id identifier rubyid_process_single_characteristic'>process_single_characteristic</span><span class='lparen'>(</span><span class='id identifier rubyid_char_config'>char_config</span><span class='comma'>,</span> <span class='id identifier rubyid_gemini_client'>gemini_client</span><span class='rparen'>)</span>
    <span class='comment'># If a single characteristic processing leads to fallback or critical failure, propagate that outcome.
</span>    <span class='kw'>return</span> <span class='id identifier rubyid_outcome'>outcome</span> <span class='kw'>if</span> <span class='id identifier rubyid_outcome'>outcome</span> <span class='op'>==</span> <span class='symbol'>:api_error_triggered_fallback</span> <span class='op'>||</span> <span class='id identifier rubyid_outcome'>outcome</span> <span class='op'>==</span> <span class='symbol'>:critical_policy_failure</span>
  <span class='kw'>end</span>

  <span class='symbol'>:ok</span> <span class='comment'># All relevant characteristics processed without triggering early exit from L2.
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="process_single_characteristic-instance_method">
  
    #<strong>process_single_characteristic</strong>(char_config, gemini_client)  &#x21d2; <tt>Symbol</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Processes a single LLM characteristic: determines relevancy, calls Gemini, and handles response.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>char_config</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Configuration for the characteristic.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>gemini_client</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Google/GeminiClient.html" title="Google::GeminiClient (class)">Google::GeminiClient</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Instance of the Gemini client.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Symbol</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>‘:ok`, `:api_error_triggered_fallback`, or `:critical_policy_failure`.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 501</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process_single_characteristic'>process_single_characteristic</span><span class='lparen'>(</span><span class='id identifier rubyid_char_config'>char_config</span><span class='comma'>,</span> <span class='id identifier rubyid_gemini_client'>gemini_client</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_characteristic_name'>characteristic_name</span> <span class='op'>=</span> <span class='id identifier rubyid_char_config'>char_config</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>name</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
  <span class='kw'>unless</span> <span class='id identifier rubyid_determine_characteristic_relevancy'>determine_characteristic_relevancy</span><span class='lparen'>(</span><span class='id identifier rubyid_char_config'>char_config</span><span class='rparen'>)</span>
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService L2_PROCESS] Skipped (relevancy): &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_characteristic_name'>characteristic_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>return</span> <span class='symbol'>:ok</span> <span class='comment'># Not relevant, but not an error state for L2 processing itself.
</span>  <span class='kw'>end</span>

  <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService L2_PROCESS] Processing relevant characteristic: &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_characteristic_name'>characteristic_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_prompt_text'>prompt_text</span> <span class='op'>=</span> <span class='id identifier rubyid_build_gemini_prompt'>build_gemini_prompt</span><span class='lparen'>(</span><span class='id identifier rubyid_char_config'>char_config</span><span class='comma'>,</span> <span class='ivar'>@pre_fetched_api_signals</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_gemini_response'>gemini_response</span> <span class='op'>=</span> <span class='id identifier rubyid_gemini_client'>gemini_client</span><span class='period'>.</span><span class='id identifier rubyid_analyze_characteristic'>analyze_characteristic</span><span class='lparen'>(</span><span class='id identifier rubyid_prompt_text'>prompt_text</span><span class='rparen'>)</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_gemini_response'>gemini_response</span><span class='op'>&amp;.</span><span class='id identifier rubyid_dig'>dig</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>error</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_error_details'>error_details</span> <span class='op'>=</span> <span class='id identifier rubyid_gemini_response'>gemini_response</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>error</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Hash</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_gemini_response'>gemini_response</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>error</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>message</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>:</span> <span class='id identifier rubyid_gemini_response'>gemini_response</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>error</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService L2_GEMINI_ERROR] for &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_characteristic_name'>characteristic_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error_details'>error_details</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_handle_api_errors_and_fallback'>handle_api_errors_and_fallback</span><span class='lparen'>(</span><span class='symbol'>:gemini_call_failed</span><span class='comma'>,</span> <span class='label'>characteristic_name:</span> <span class='id identifier rubyid_characteristic_name'>characteristic_name</span><span class='comma'>,</span> <span class='label'>error_message:</span> <span class='id identifier rubyid_error_details'>error_details</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='symbol'>:api_error_triggered_fallback</span>
  <span class='kw'>elsif</span> <span class='op'>!</span><span class='lparen'>(</span><span class='id identifier rubyid_gemini_response'>gemini_response</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_gemini_response'>gemini_response</span><span class='period'>.</span><span class='id identifier rubyid_key?'>key?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>confidence_score</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_gemini_response'>gemini_response</span><span class='period'>.</span><span class='id identifier rubyid_key?'>key?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>rationale</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService L2_GEMINI_ERROR] Malformed response for &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_characteristic_name'>characteristic_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_gemini_response'>gemini_response</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='period'>.</span><span class='id identifier rubyid_truncate'>truncate</span><span class='lparen'>(</span><span class='int'>500</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_handle_api_errors_and_fallback'>handle_api_errors_and_fallback</span><span class='lparen'>(</span><span class='symbol'>:gemini_response_malformed</span><span class='comma'>,</span> <span class='label'>characteristic_name:</span> <span class='id identifier rubyid_characteristic_name'>characteristic_name</span><span class='comma'>,</span> <span class='label'>response:</span> <span class='id identifier rubyid_gemini_response'>gemini_response</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='period'>.</span><span class='id identifier rubyid_truncate'>truncate</span><span class='lparen'>(</span><span class='int'>500</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='symbol'>:api_error_triggered_fallback</span>
  <span class='kw'>end</span>

  <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService L2_GEMINI_SUCCESS] for &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_characteristic_name'>characteristic_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;. Score: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_gemini_response'>gemini_response</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>confidence_score</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_llm_confidence'>llm_confidence</span> <span class='op'>=</span> <span class='id identifier rubyid_gemini_response'>gemini_response</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>confidence_score</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
  <span class='id identifier rubyid_llm_rationale'>llm_rationale</span> <span class='op'>=</span> <span class='id identifier rubyid_gemini_response'>gemini_response</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>rationale</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
  <span class='id identifier rubyid_add_l2_violation_detail'>add_l2_violation_detail</span><span class='lparen'>(</span><span class='id identifier rubyid_characteristic_name'>characteristic_name</span><span class='comma'>,</span> <span class='id identifier rubyid_llm_rationale'>llm_rationale</span><span class='comma'>,</span> <span class='id identifier rubyid_llm_confidence'>llm_confidence</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_critical_threshold_value'>critical_threshold_value</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="SmsPolicyCheckerService (class)">SmsPolicyCheckerService</a></span></span><span class='op'>::</span><span class='const'>CRITICAL_FAILURE_THRESHOLDS</span><span class='op'>&amp;.</span><span class='id identifier rubyid_dig'>dig</span><span class='lparen'>(</span><span class='id identifier rubyid_characteristic_name'>characteristic_name</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_critical_threshold_value'>critical_threshold_value</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_llm_confidence'>llm_confidence</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_critical_threshold_value'>critical_threshold_value</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
    <span class='id identifier rubyid_set_critical_l2_failure'>set_critical_l2_failure</span><span class='lparen'>(</span><span class='id identifier rubyid_characteristic_name'>characteristic_name</span><span class='comma'>,</span> <span class='id identifier rubyid_llm_confidence'>llm_confidence</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='symbol'>:critical_policy_failure</span>
  <span class='kw'>end</span>
  <span class='symbol'>:ok</span> <span class='comment'># Processed successfully
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="set_critical_l2_failure-instance_method">
  
    #<strong>set_critical_l2_failure</strong>(characteristic_name, confidence)  &#x21d2; <tt>void</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Updates the analysis report to reflect a critical failure based on a Layer 2 LLM characteristic evaluation that met or exceeded its critical threshold. Sets the result to ‘:fail`, updates overall confidence, and sets the reason to the characteristic name.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>characteristic_name</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The name of the characteristic that caused the critical failure.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>confidence</span>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The confidence score from the LLM for this characteristic.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


566
567
568
569
570
571</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 566</span>

<span class='kw'>def</span> <span class='id identifier rubyid_set_critical_l2_failure'>set_critical_l2_failure</span><span class='lparen'>(</span><span class='id identifier rubyid_characteristic_name'>characteristic_name</span><span class='comma'>,</span> <span class='id identifier rubyid_confidence'>confidence</span><span class='rparen'>)</span>
  <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_warn'>warn</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService L2_CRITICAL] Critical failure for &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_characteristic_name'>characteristic_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;. Score: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_confidence'>confidence</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:result</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='symbol'>:fail</span>
  <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:confidence</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_confidence'>confidence</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
  <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:reason</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_characteristic_name'>characteristic_name</span> <span class='comment'># For critical L2, the characteristic is the direct reason
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="set_early_exit_failure-instance_method">
  
    #<strong>set_early_exit_failure</strong>(rule)  &#x21d2; <tt>void</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Updates the analysis report to reflect an early exit failure based on a Layer 1 rule. Sets the result to ‘:fail`, updates confidence, and sets the reason.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>rule</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The Layer 1 rule configuration hash that triggered the early exit. Expected keys: “name”, “individual_confidence”, “mapped_policy_category”.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


207
208
209
210
211
212
213
214
215
216
217
218
219</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 207</span>

<span class='kw'>def</span> <span class='id identifier rubyid_set_early_exit_failure'>set_early_exit_failure</span><span class='lparen'>(</span><span class='id identifier rubyid_rule'>rule</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_category'>category</span> <span class='op'>=</span> <span class='id identifier rubyid_rule'>rule</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>mapped_policy_category</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
  <span class='id identifier rubyid_current_score'>current_score</span> <span class='op'>=</span> <span class='id identifier rubyid_rule'>rule</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>individual_confidence</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
  <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:result</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='symbol'>:fail</span>
  <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:confidence</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_current_score'>current_score</span>
  <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:reason</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:processing_mode</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='symbol'>:fallback_layer1_only</span>
                                        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Fallback: Early Exit - Violation Category: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_category'>category</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
                                      <span class='kw'>else</span>
                                        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Early Exit - Violation Category: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_category'>category</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
                                      <span class='kw'>end</span>

  <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SmsPolicyCheckerService L1] Early Exit triggered by rule &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_rule'>rule</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>name</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;. Reason: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@message_analysis_report</span><span class='lbracket'>[</span><span class='symbol'>:reason</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>. Confidence: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_current_score'>current_score</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="summarize_nl_entities_for_prompt-instance_method">
  
    #<strong>summarize_nl_entities_for_prompt</strong>(signals)  &#x21d2; <tt>String</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Generates a summary string for Natural Language Entities results to be used in prompts.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>signals</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The pre_fetched_api_signals hash.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>A textual summary of NL Entities results.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


389
390
391
392
393
394
395
396
397
398
399
400</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 389</span>

<span class='kw'>def</span> <span class='id identifier rubyid_summarize_nl_entities_for_prompt'>summarize_nl_entities_for_prompt</span><span class='lparen'>(</span><span class='id identifier rubyid_signals'>signals</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_nl_data'>nl_data</span> <span class='op'>=</span> <span class='id identifier rubyid_signals'>signals</span><span class='lbracket'>[</span><span class='symbol'>:nl_api_result</span><span class='rbracket'>]</span>
  <span class='kw'>return</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>N/A (NL API data missing)</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_nl_data'>nl_data</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_nl_data'>nl_data</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>error</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>NL Entity API data unavailable: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_nl_data'>nl_data</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>error</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_nl_data'>nl_data</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>entities</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_nl_data'>nl_data</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>entities</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_any?'>any?</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Detected Entities: </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_nl_data'>nl_data</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>entities</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='lparen'>(</span><span class='int'>5</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_e'>e</span><span class='op'>|</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>name</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'> (Type: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>type</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>; </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>No notable entities detected by NL API.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="summarize_nl_moderation_for_prompt-instance_method">
  
    #<strong>summarize_nl_moderation_for_prompt</strong>(signals)  &#x21d2; <tt>String</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Generates a summary string for Text Moderation results to be used in prompts.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>signals</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The pre_fetched_api_signals hash.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>A textual summary of Text Moderation results.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 406</span>

<span class='kw'>def</span> <span class='id identifier rubyid_summarize_nl_moderation_for_prompt'>summarize_nl_moderation_for_prompt</span><span class='lparen'>(</span><span class='id identifier rubyid_signals'>signals</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_mod_data'>mod_data</span> <span class='op'>=</span> <span class='id identifier rubyid_signals'>signals</span><span class='lbracket'>[</span><span class='symbol'>:moderation_result</span><span class='rbracket'>]</span>
  <span class='kw'>return</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>N/A (Moderation API data missing)</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_mod_data'>mod_data</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_mod_data'>mod_data</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>error</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Text Moderation API data unavailable: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_mod_data'>mod_data</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>error</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_mod_data'>mod_data</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>moderationCategories</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_mod_data'>mod_data</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>moderationCategories</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_any?'>any?</span>
    <span class='comment'># Filter for categories with confidence &gt;= 0.5 (or adjust as needed)
</span>    <span class='id identifier rubyid_flagged_cats'>flagged_cats</span> <span class='op'>=</span> <span class='id identifier rubyid_mod_data'>mod_data</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>moderationCategories</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_cat'>cat</span><span class='op'>|</span> <span class='id identifier rubyid_cat'>cat</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>confidence</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>&gt;=</span> <span class='float'>0.5</span> <span class='rbrace'>}</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_flagged_cats'>flagged_cats</span><span class='period'>.</span><span class='id identifier rubyid_any?'>any?</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Text Moderation signals: </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_flagged_cats'>flagged_cats</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_cat'>cat</span><span class='op'>|</span>
        <span class='id identifier rubyid_cat_name'>cat_name</span> <span class='op'>=</span> <span class='id identifier rubyid_cat'>cat</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>name</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span> <span class='comment'># Get the last part of the category path
</span>        <span class='id identifier rubyid_severity_info'>severity_info</span> <span class='op'>=</span> <span class='id identifier rubyid_cat'>cat</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>severity</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> (Severity: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_cat'>cat</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>severity</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span><span class='period'>.</span><span class='id identifier rubyid_round'>round</span><span class='lparen'>(</span><span class='int'>2</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_cat_name'>cat_name</span><span class='embexpr_end'>}</span><span class='tstring_content'> (Confidence: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_cat'>cat</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>confidence</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span><span class='period'>.</span><span class='id identifier rubyid_round'>round</span><span class='lparen'>(</span><span class='int'>2</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_severity_info'>severity_info</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>; </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>No significant moderation categories flagged by NL API (threshold 0.5).</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>No moderation categories reported by NL API.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="summarize_safe_browse_for_prompt-instance_method">
  
    #<strong>summarize_safe_browse_for_prompt</strong>(signals)  &#x21d2; <tt>String</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Generates a summary string for Safe Browse results to be used in prompts.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>signals</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The pre_fetched_api_signals hash.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>A textual summary of Safe Browse results.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


372
373
374
375
376
377
378
379
380
381
382
383</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/services/sms_policy_checker_service.rb', line 372</span>

<span class='kw'>def</span> <span class='id identifier rubyid_summarize_safe_browse_for_prompt'>summarize_safe_browse_for_prompt</span><span class='lparen'>(</span><span class='id identifier rubyid_signals'>signals</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>N/A (No URLs in message)</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_signals'>signals</span><span class='lbracket'>[</span><span class='symbol'>:urls_present</span><span class='rbracket'>]</span>

  <span class='id identifier rubyid_sb_res'>sb_res</span> <span class='op'>=</span> <span class='id identifier rubyid_signals'>signals</span><span class='lbracket'>[</span><span class='symbol'>:safe_browse_result</span><span class='rbracket'>]</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_sb_res'>sb_res</span><span class='op'>&amp;.</span><span class='id identifier rubyid_dig'>dig</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>error</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Safe Browse data unavailable: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_sb_res'>sb_res</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>error</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_sb_res'>sb_res</span><span class='op'>&amp;.</span><span class='id identifier rubyid_dig'>dig</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>matches</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='op'>&amp;.</span><span class='id identifier rubyid_any?'>any?</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Flagged by Safe Browse: </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_sb_res'>sb_res</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>matches</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_m'>m</span><span class='op'>|</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_m'>m</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>threatType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'> for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_m'>m</span><span class='period'>.</span><span class='id identifier rubyid_dig'>dig</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>threat</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>url</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>; </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>No threats found by Safe Browse for present URLs.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Sun May 11 17:52:35 2025 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.37 (ruby-3.4.3).
</div>

    </div>
  </body>
</html>